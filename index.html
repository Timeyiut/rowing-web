<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rowing Pro Web - é›™é¡é ­å„ªåŒ–ç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        
        #output_canvas { width: 100%; height: auto; object-fit: contain; }
        /* é¡åƒç¿»è½‰é¡åˆ¥ */
        .mirrored { transform: scaleX(-1); }
        
        #input_video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        #ui-panel {
            position: absolute; top: 10px; left: 10px; right: 10px;
            padding: 10px; background: rgba(0, 0, 0, 0.6); border-radius: 8px;
            z-index: 10; pointer-events: none;
        }
        .data-line { margin: 2px 0; font-size: 14px; }
        
        #debug-log {
            position: absolute; bottom: 85px; left: 10px; right: 10px;
            font-size: 10px; color: #0f0; background: rgba(0,0,0,0.5); padding: 5px;
        }

        /* æŒ‰éˆ•å€åŸŸ */
        #controls {
            position: absolute; bottom: 20px; width: 100%;
            display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; z-index: 20;
        }
        button {
            padding: 10px 15px; border-radius: 20px; border: none; 
            font-weight: bold; background: #2196F3; color: white; cursor: pointer;
        }
        .btn-active { background: #ff9800 !important; }
    </style>
</head>
<body>

<div id="container">
    <video id="input_video" playsinline muted autoplay></video>
    <canvas id="output_canvas" class="mirrored"></canvas> <div id="ui-panel">
        <div id="val-hr" style="font-size: 20px; color: #ff3d00;">HR: 0 bpm</div>
        <div id="val-phase" style="color: #00ff00;">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
        <div class="data-line">KNEE: <span id="ang-knee">0</span> | HIP: <span id="ang-hip">0</span></div>
    </div>

    <div id="debug-log">é¡é ­ç‹€æ…‹: ç­‰å¾…å•Ÿå‹•...</div>

    <div id="controls">
        <button id="btn-switch-cam">ğŸ”„ åˆ‡æ›é¡é ­</button>
        <button id="btn-bluetooth" style="background: #e91e63;">ğŸ”— é€£ç·šå¿ƒç‡</button>
        <button id="btn-download" style="background: #4caf50;">ğŸ’¾ ä¸‹è¼‰ CSV</button>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const debugLog = document.getElementById('debug-log');

    let cameraInstance = null;
    let currentFacingMode = 'user'; // 'user' ç‚ºå‰é¡é ­, 'environment' ç‚ºå¾Œé¡é ­
    let currentHR = 0;
    let csvData = [["Timestamp", "HeartRate", "Knee", "Hip", "Elbow", "Phase"]];

    function log(msg) {
        debugLog.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    }

    // 1. MediaPipe Pose è¨­å®š
    const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    function calculateAngle(a, b, c) {
        let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    pose.onResults((results) => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
            const lm = results.poseLandmarks;
            const knee = calculateAngle(lm[23], lm[25], lm[27]);
            const hip = calculateAngle(lm[11], lm[23], lm[25]);
            
            document.getElementById('ang-knee').innerText = knee;
            document.getElementById('ang-hip').innerText = hip;
            document.getElementById('val-phase').innerText = "PHASE: Tracking OK";
            
            // æ•¸æ“šè¨˜éŒ„
            const now = new Date();
            csvData.push([now.toISOString(), currentHR, knee, hip, 0, "Tracking"]);
        }
        canvasCtx.restore();
    });

    // 2. é¡é ­å•Ÿå‹•èˆ‡åˆ‡æ›é‚è¼¯
    async function startCamera(mode) {
        log(`æ­£åœ¨å•Ÿå‹• ${mode === 'user' ? 'å‰ç½®' : 'å¾Œç½®'} é¡é ­...`);
        
        // è™•ç†ç•«é¢çš„é¡åƒç¿»è½‰
        if (mode === 'user') {
            canvasElement.classList.add('mirrored');
        } else {
            canvasElement.classList.remove('mirrored');
        }

        // å¦‚æœå·²æœ‰èˆŠé¡é ­åœ¨åŸ·è¡Œï¼Œå…ˆåœæ­¢å®ƒ
        if (cameraInstance) {
            await cameraInstance.stop();
        }

        try {
            cameraInstance = new Camera(videoElement, {
                onFrame: async () => {
                    await pose.send({image: videoElement});
                },
                width: 640,
                height: 480,
                facingMode: mode
            });
            await cameraInstance.start();
            currentFacingMode = mode;
            log(`é¡é ­å·²é–‹å•Ÿ: ${mode}`);
        } catch (err) {
            log(`éŒ¯èª¤: ${err.message}`);
        }
    }

    // åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
    document.getElementById('btn-switch-cam').addEventListener('click', () => {
        const nextMode = (currentFacingMode === 'user') ? 'environment' : 'user';
        startCamera(nextMode);
    });

    // 3. è—ç‰™èˆ‡ CSV åŠŸèƒ½
    document.getElementById('btn-bluetooth').addEventListener('click', async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['heart_rate'] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('heart_rate');
            const char = await service.getCharacteristic('heart_rate_measurement');
            await char.startNotifications();
            log("è—ç‰™å¿ƒç‡å¸¶å·²é€£ç·šï¼");
            document.getElementById('btn-bluetooth').classList.add('btn-active');
            char.addEventListener('characteristicvaluechanged', (e) => {
                currentHR = e.target.value.getUint8(1);
                document.getElementById('val-hr').innerText = `HR: ${currentHR} bpm`;
            });
        } catch (err) {
            log(`è—ç‰™éŒ¯èª¤: ${err}`);
        }
    });

    document.getElementById('btn-download').addEventListener('click', () => {
        const csvContent = "data:text/csv;charset=utf-8," + csvData.map(e => e.join(",")).join("\n");
        const link = document.createElement("a");
        link.href = encodeURI(csvContent);
        link.download = `rowing_${new Date().getTime()}.csv`;
        link.click();
        log("CSV å·²åŒ¯å‡ºï¼Œè«‹æª¢æŸ¥ã€æª”æ¡ˆã€App ä¸‹è¼‰é …ç›®ã€‚");
    });

    // åˆå§‹å•Ÿå‹•
    window.onload = () => startCamera('user');
</script>
</body>
</html>