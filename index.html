<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowing Pro Web - 劃船即時分析系統</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* 隱藏原始影片，只顯示處理後的 Canvas */
        #input_video { display: none; }
        #output_canvas { max-width: 100%; max-height: 100%; transform: scaleX(-1); } /* 鏡像顯示 */

        /* UI 面板 */
        #ui-panel {
            position: absolute; top: 20px; left: 20px;
            width: 280px; padding: 15px;
            background: rgba(0, 0, 0, 0.7); border-radius: 10px;
            pointer-events: none; /* 點擊穿透 */
        }
        .data-line { margin: 5px 0; font-size: 16px; }
        .highlight { font-weight: bold; color: #0f0; }
        .angle-val { color: #ffeb3b; }

        /* 控制按鈕 */
        #controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 15px;
        }
        button {
            padding: 12px 24px; font-size: 16px; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer;
            background: #2196F3; color: white; transition: 0.3s;
        }
        button:hover { background: #1976D2; }
        #btn-bluetooth { background: #e91e63; }
        #btn-download { background: #4caf50; }
    </style>
</head>
<body>

<div id="container">
    <video id="input_video"></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui-panel">
        <div id="val-time" class="data-line">TIME: --:--:--</div>
        <div id="val-hr" class="data-line" style="font-size: 24px;">HR: 0 bpm <span id="hr-src" style="font-size: 14px;">(NONE)</span></div>
        <div id="val-phase" class="data-line" style="color: #00ff00; font-size: 20px;">PHASE: Ready</div>
        <hr>
        <div class="data-line">KNEE: <span id="ang-knee" class="angle-val">0</span> deg</div>
        <div class="data-line">HIP: <span id="ang-hip" class="angle-val">0</span> deg</div>
        <div class="data-line">ELBOW: <span id="ang-elbow" class="angle-val">0</span> deg</div>
    </div>

    <div id="controls">
        <button id="btn-bluetooth">連線心率帶</button>
        <button id="btn-download">下載 CSV</button>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // 數據狀態
    let currentHR = 0;
    let csvData = [["Timestamp", "HeartRate", "Knee", "Hip", "Elbow", "Phase"]];

    // 1. 初始化 MediaPipe Pose
    const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    // 2. 角度計演算法 (與 Python 版一致)
    function calculateAngle(a, b, c) {
        let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    // 3. 處理偵測結果
    function onResults(results) {
        // 設定 Canvas 尺寸
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        // 繪製背景影像
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            // 繪製骨架
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});

            // 取得關節點 (MediaPipe JS 座標是 0~1)
            const lm = results.poseLandmarks;
            const knee = calculateAngle(lm[23], lm[25], lm[27]);
            const hip = calculateAngle(lm[11], lm[23], lm[25]);
            const elbow = calculateAngle(lm[11], lm[13], lm[15]);

            // 更新 UI
            document.getElementById('ang-knee').innerText = knee;
            document.getElementById('ang-hip').innerText = hip;
            document.getElementById('ang-elbow').innerText = elbow;

            // 相位判斷
            let phase = "Drive/Rec";
            if (knee < 80) phase = "Catch";
            else if (knee > 150 && elbow < 110) phase = "Finish";
            document.getElementById('val-phase').innerText = "PHASE: " + phase;

            // 更新時間與紀錄數據
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                            now.getMinutes().toString().padStart(2, '0') + ":" + 
                            now.getSeconds().toString().padStart(2, '0');
            document.getElementById('val-time').innerText = "TIME: " + timeStr;
            
            csvData.push([now.toISOString(), currentHR, knee, hip, elbow, phase]);
        }
        canvasCtx.restore();
    }

    pose.onResults(onResults);

    // 4. 啟動相機
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await pose.send({image: videoElement});
        },
        width: 640,
        height: 480
    });
    camera.start();

    // 5. Web Bluetooth 心率連線
    document.getElementById('btn-bluetooth').addEventListener('click', async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['heart_rate'] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('heart_rate');
            const characteristic = await service.getCharacteristic('heart_rate_measurement');
            
            await characteristic.startNotifications();
            document.getElementById('hr-src').innerText = "(BLE)";
            document.getElementById('btn-bluetooth').innerText = "藍牙已連線";

            characteristic.addEventListener('characteristicvaluechanged', (event) => {
                const value = event.target.value;
                currentHR = value.getUint8(1);
                document.getElementById('val-hr').innerHTML = `HR: <span style="color:#ff3d00">${currentHR}</span> bpm`;
            });
        } catch (error) {
            alert("連線失敗: " + error);
        }
    });

    // 6. CSV 下載功能
    document.getElementById('btn-download').addEventListener('click', () => {
        let csvContent = "data:text/csv;charset=utf-8," + csvData.map(e => e.join(",")).join("\n");
        let encodedUri = encodeURI(csvContent);
        let link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "rowing_web_data.csv");
        document.body.appendChild(link);
        link.click();
    });

</script>
</body>
</html>