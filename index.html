<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rowing Motion Analysis v8.1</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg: #121212; --panel: rgba(30, 30, 30, 0.9); --accent: #00E5FF; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* ä¸»èˆå° */
        #stage { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; opacity: 0; pointer-events: none; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirrored { transform: scaleX(-1); }

        /* æ•¸æ“šå„€è¡¨æ¿ */
        #hud {
            position: absolute; top: 10px; left: 10px; padding: 12px;
            background: var(--panel); border-radius: 8px; border-left: 4px solid var(--accent);
            pointer-events: none; z-index: 10;
        }
        .row { display: flex; gap: 15px; margin-bottom: 5px; font-size: 14px; }
        .label { color: #aaa; }
        .val { font-weight: bold; font-size: 16px; }
        
        #status-pill {
            display: inline-block; padding: 4px 8px; border-radius: 4px; 
            font-weight: bold; font-size: 12px; margin-top: 5px;
            background: #333; color: #fff; width: 100%; text-align: center;
        }

        /* åº•éƒ¨æ§åˆ¶ */
        #controls {
            height: 70px; background: #1e1e1e; border-top: 1px solid #333;
            display: flex; gap: 10px; padding: 10px; align-items: center; justify-content: center; z-index: 20;
        }
        button, label {
            flex: 1; height: 100%; border: none; border-radius: 6px;
            background: #333; color: #ccc; font-weight: bold; font-size: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .primary { background: var(--accent); color: #000; }
        .btn-icon { font-size: 18px; margin-bottom: 2px; }

        /* å•Ÿå‹•é®ç½© */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn { flex: 0; height: 50px; width: 200px; font-size: 18px; background: var(--accent); color: #000; border-radius: 25px; border:none; }
        
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <button id="start-btn" onclick="initSystem()">ğŸš€ å•Ÿå‹•å§¿æ…‹åˆ†æ</button>
    </div>

    <div id="stage">
        <video id="video" playsinline muted webkit-playsinline loop crossorigin="anonymous"></video>
        <canvas id="canvas"></canvas>

        <div id="hud">
            <div class="row"><span class="label">Phase:</span> <span id="val-phase" class="val">--</span></div>
            <div class="row"><span class="label">Knee Angle:</span> <span id="val-knee" class="val">0Â°</span></div>
            <div class="row"><span class="label">Hip Angle:</span> <span id="val-hip" class="val">0Â°</span></div>
            <div class="row"><span class="label">Elbow Angle:</span> <span id="val-elbow" class="val">0Â°</span></div>
            <div id="status-pill">SYSTEM READY</div>
        </div>
    </div>

    <div id="controls">
        <button onclick="forceRender()">
            <div class="btn-icon">âš¡</div>å¼·åˆ¶åŸ·è¡Œ
        </button>
        <label for="file-input" class="primary">
            <div class="btn-icon">ğŸ“‚</div>åŒ¯å…¥å½±ç‰‡
        </label>
        <button onclick="startCamera()">
            <div class="btn-icon">ğŸ“·</div>é–‹å•Ÿç›¸æ©Ÿ
        </button>
        <button onclick="exportCSV()">
            <div class="btn-icon">ğŸ’¾</div>å°å‡ºæ•¸æ“š
        </button>
    </div>

    <input type="file" id="file-input" accept="video/*">

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let pose = null;
    let isProcessing = false;
    let isVideoMode = false;
    let facingMode = 'user';
    let animationId;

    // åˆ†æè®Šæ•¸
    let prevKneeAngle = 0;
    let currentPhase = "IDLE";
    let dataLog = [["Timestamp", "Phase", "Knee", "Hip", "Elbow"]];

    // --- 1. ç³»çµ±åˆå§‹åŒ– ---
    async function initSystem() {
        document.getElementById('overlay').style.display = 'none';
        try {
            pose = new Pose({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            pose.onResults(onResults);
            await pose.initialize();
            document.getElementById('status-pill').innerText = "WAITING FOR INPUT";
        } catch (e) { alert("åˆå§‹åŒ–å¤±æ•—"); }
    }

    // --- 2. æ ¸å¿ƒåˆ†æèˆ‡ OpenCV Style ç¹ªåœ– ---
    function onResults(results) {
        if (canvas.width !== video.videoWidth) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            const lm = results.poseLandmarks;
            const w = canvas.width;
            const h = canvas.height;

            // è‡ªå‹•åµæ¸¬è¦–è§’å´é‚Š
            const isLeft = lm[11].visibility > lm[12].visibility;
            const offset = isLeft ? 0 : 1; 

            // é—œéµé—œç¯€åº§æ¨™
            const ankle = { x: lm[27+offset].x * w, y: lm[27+offset].y * h };
            const knee  = { x: lm[25+offset].x * w, y: lm[25+offset].y * h };
            const hip   = { x: lm[23+offset].x * w, y: lm[23+offset].y * h };
            const shoulder = { x: lm[11+offset].x * w, y: lm[11+offset].y * h };
            const elbow = { x: lm[13+offset].x * w, y: lm[13+offset].y * h };
            const wrist = { x: lm[15+offset].x * w, y: lm[15+offset].y * h };

            // è¨ˆç®—è§’åº¦
            const kneeAngle = getAngle(hip, knee, ankle);
            const hipAngle = getAngle(shoulder, hip, knee);
            const elbowAngle = getAngle(shoulder, elbow, wrist);
            
            // åˆ’èˆ¹ç›¸ä½åˆ¤æ–· (è†è“‹è§’é€Ÿåº¦)
            if (kneeAngle > prevKneeAngle + 0.5) {
                currentPhase = "DRIVE (æ‹‰æ§³)";
            } else if (kneeAngle < prevKneeAngle - 0.5) {
                currentPhase = "RECOVERY (å›æ§³)";
            }
            prevKneeAngle = kneeAngle;

            // ç¹ªè£½éª¨æ¶ (OpenCV é¢¨æ ¼ç²—ç™½ç·š)
            drawSkeleton(ctx, [shoulder, elbow, wrist], "#FFFFFF", 5);
            drawSkeleton(ctx, [shoulder, hip, knee, ankle], "#FFFFFF", 5);
            
            // ç¹ªè£½é—œç¯€é»
            drawKeypoint(ctx, knee, "#00E5FF"); // è†è“‹è—
            drawKeypoint(ctx, hip, "#00E5FF");
            drawKeypoint(ctx, elbow, "#00E5FF");
            drawKeypoint(ctx, wrist, "#FFD700"); // æ‰‹éƒ¨é‡‘è‰²

            // æ›´æ–° UI
            updateHUD(currentPhase, kneeAngle, hipAngle, elbowAngle);
            
            // æ•¸æ“šè¨˜éŒ„
            const ts = isVideoMode ? video.currentTime.toFixed(2) : new Date().toLocaleTimeString();
            dataLog.push([ts, currentPhase, kneeAngle, hipAngle, elbowAngle]);
        }
        ctx.restore();
    }

    // --- 3. ç¹ªåœ–è¼”åŠ© ---
    function drawKeypoint(ctx, p, color) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function drawSkeleton(ctx, points, color, width) {
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = "round";
        ctx.stroke();
    }

    function getAngle(p1, p2, p3) {
        const a1 = Math.atan2(p1.y - p2.y, p1.x - p2.x);
        const a2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
        let ang = Math.abs((a2 - a1) * 180 / Math.PI);
        if (ang > 180) ang = 360 - ang;
        return Math.round(ang);
    }

    function updateHUD(phase, knee, hip, elbow) {
        document.getElementById('val-phase').innerText = phase;
        document.getElementById('val-knee').innerText = knee + "Â°";
        document.getElementById('val-hip').innerText = hip + "Â°";
        document.getElementById('val-elbow').innerText = elbow + "Â°";
        
        const pill = document.getElementById('status-pill');
        pill.innerText = phase;
        pill.style.background = phase.includes("DRIVE") ? "#FF3D00" : "#00E676";
        pill.style.color = phase.includes("DRIVE") ? "#fff" : "#000";
    }

    // --- 4. ç³»çµ±æ§åˆ¶ ---
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        stopAll();
        isVideoMode = true;
        canvas.classList.remove('mirrored');
        video.src = URL.createObjectURL(file);
        video.onloadeddata = () => { video.play(); isProcessing = true; processLoop(); };
    };

    function startCamera() {
        stopAll();
        isVideoMode = false;
        canvas.classList.add('mirrored');
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'user', width: 1280, height: 720}})
            .then(s => {
                video.srcObject = s;
                video.onloadedmetadata = () => { video.play(); isProcessing = true; processLoop(); };
            }).catch(e => alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"));
    }

    function forceRender() {
        if (video.src || video.srcObject) { video.play(); isProcessing = true; processLoop(); }
    }

    function processLoop() {
        if (!isProcessing) return;
        if (!video.paused && !video.ended) pose.send({image: video});
        animationId = requestAnimationFrame(processLoop);
    }

    function stopAll() {
        isProcessing = false;
        if (animationId) cancelAnimationFrame(animationId);
        video.pause();
        if (video.srcObject) { video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null;}
        video.src="";
    }

    function exportCSV() {
        const csv = dataLog.map(r => r.join(",")).join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
        a.download = `rowing_analysis_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>