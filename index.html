<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rowing Pro - iOS Analysis Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg: #0d1117; --panel: rgba(22, 27, 34, 0.85); --accent: #2f81f7; --text: #e6edf3; --green: #3fb950; --red: #ff7b72; }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, system-ui; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* ç•«å¸ƒå®¹å™¨ */
        #viewer { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        canvas { width: 100%; height: 100%; object-fit: contain; z-index: 5; }
        .mirrored { transform: scaleX(-1); }

        /* HUD å„€è¡¨æ¿ */
        #hud {
            position: absolute; top: 20px; left: 15px; right: 15px;
            padding: 15px; background: var(--panel); border-radius: 12px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); z-index: 10;
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        .metric { display: flex; flex-direction: column; }
        .label { font-size: 10px; color: #8b949e; text-transform: uppercase; }
        .value { font-size: 18px; font-weight: bold; font-family: monospace; }
        #phase-badge { grid-column: span 2; text-align: center; color: var(--green); background: rgba(63, 185, 80, 0.1); padding: 5px; border-radius: 4px; margin-top: 5px; }

        /* å½±ç‰‡é€²åº¦æ¢ */
        #timeline { position: absolute; bottom: 90px; left: 20px; right: 20px; height: 30px; z-index: 15; display: none; align-items: center; }
        #progress-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; cursor: pointer; }
        #progress-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 3px; }

        /* æ§åˆ¶åˆ— */
        #controls { height: 80px; background: var(--panel); display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid rgba(255,255,255,0.1); }
        .btn { display: flex; flex-direction: column; align-items: center; color: #8b949e; text-decoration: none; font-size: 10px; background: none; border: none; }
        .btn-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; margin-bottom: 4px; }
        .active .btn-icon { background: var(--accent); color: #fff; }

        /* ç³»çµ±æ—¥èªŒ (é™¤éŒ¯ç”¨) */
        #sys-log { position: absolute; bottom: 130px; left: 15px; right: 15px; font-size: 10px; color: #58a6ff; pointer-events: none; }

        #file-input { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="viewer">
        <video id="video" playsinline muted webkit-playsinline></video>
        <canvas id="canvas" class="mirrored"></canvas>
        
        <div id="hud">
            <div class="metric"><span class="label">Clock</span><span id="ui-time" class="value">--:--:--</span></div>
            <div class="metric"><span class="label">Heart Rate</span><span id="ui-hr" class="value" style="color:var(--red)">-- bpm</span></div>
            <div class="metric"><span class="label">Knee Angle</span><span id="ui-knee" class="value">0Â°</span></div>
            <div class="metric"><span class="label">Hip Angle</span><span id="ui-hip" class="value">0Â°</span></div>
            <div id="phase-badge" class="value">INITIALIZING...</div>
        </div>

        <div id="timeline"><div id="progress-bg"><div id="progress-fill"></div></div></div>
        <div id="sys-log">ç³»çµ±æº–å‚™å°±ç·’</div>
    </div>

    <div id="controls">
        <button class="btn" onclick="startMode('camera')"><div class="btn-icon">ğŸ“·</div><span>ç›¸æ©Ÿ</span></button>
        <button class="btn" onclick="toggleFlip()"><div class="btn-icon">ğŸ”„</div><span>ç¿»è½‰</span></button>
        <label for="file-input" class="btn"><div class="btn-icon">ğŸ“‚</div><span>åŒ¯å…¥</span></label>
        <button class="btn" onclick="connectBLE()"><div class="btn-icon">â¤ï¸</div><span>è—ç‰™</span></button>
        <button class="btn" onclick="exportData()"><div class="btn-icon">ğŸ’¾</div><span>å°å‡º</span></button>
    </div>
    <input type="file" id="file-input" accept="video/*">
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const log = (m) => document.getElementById('sys-log').innerText = `[LOG] ${m}`;

    let pose, camera, isVideo = false, facing = 'user';
    let bleHR = 0, history = [["TS", "HR", "Knee", "Hip", "Phase"]];

    // --- 1. åˆå§‹åŒ– AI å¼•æ“ ---
    async function init() {
        pose = new Pose({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);
        log("MediaPipe å·²è¼‰å…¥");
    }

    // --- 2. æ ¸å¿ƒåˆ†æé‚è¼¯ (åŒ…å«è§’åº¦èˆ‡ç›¸ä½) ---
    function calculateAngle(p1, p2, p3) {
        const rad = Math.atan2(p3.y - p2.y, p3.x - p2.x) - Math.atan2(p1.y - p2.y, p1.x - p2.x);
        let ang = Math.abs(rad * 180.0 / Math.PI);
        return Math.round(ang > 180 ? 360 - ang : ang);
    }

    function onResults(res) {
        if (!res.poseLandmarks) return;
        
        // ä¿®æ­£ç•«å¸ƒå°ºå¯¸
        if (canvas.width !== video.videoWidth) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
        
        drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
        
        const lm = res.poseLandmarks;
        const knee = calculateAngle(lm[23], lm[25], lm[27]);
        const hip = calculateAngle(lm[11], lm[23], lm[25]);
        
        // æ›´æ–° UI
        document.getElementById('ui-knee').innerText = `${knee}Â°`;
        document.getElementById('ui-hip').innerText = `${hip}Â°`;
        
        const now = new Date();
        const ts = isVideo ? video.currentTime.toFixed(2) : now.toLocaleTimeString();
        document.getElementById('ui-time').innerText = ts;

        let ph = "DRIVE";
        if (knee < 85) ph = "CATCH"; else if (knee > 155) ph = "FINISH";
        document.getElementById('phase-badge').innerText = ph;

        if (isVideo) {
            const pct = (video.currentTime / video.duration) * 100;
            document.getElementById('progress-fill').style.width = pct + '%';
        }

        history.push([ts, bleHR, knee, hip, ph]);
        ctx.restore();
    }

    // --- 3. å½±åƒæµæ§åˆ¶ (ä¿®å¾©åŒ¯å…¥ç„¡åæ‡‰å•é¡Œ) ---
    async function startMode(type) {
        isVideo = (type === 'video');
        document.getElementById('timeline').style.display = isVideo ? 'flex' : 'none';
        
        if (camera) await camera.stop();
        video.pause();

        if (type === 'camera') {
            canvas.classList.add('mirrored');
            camera = new Camera(video, {
                onFrame: async () => { await pose.send({image: video}); },
                width: 1280, height: 720, facingMode: facing
            });
            camera.start();
        }
    }

    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        log(`åŒ¯å…¥å½±ç‰‡: ${file.name}`);
        startMode('video');
        canvas.classList.remove('mirrored');
        
        const url = URL.createObjectURL(file);
        video.src = url;
        
        // é—œéµï¼šç­‰å¾…è¼‰å…¥ä¸¦å•Ÿå‹•å¾ªç’°
        video.onloadeddata = () => {
            video.play();
            const process = async () => {
                if (!isVideo || video.paused || video.ended) return;
                await pose.send({image: video});
                requestAnimationFrame(process);
            };
            process();
        };
    };

    function toggleFlip() { facing = (facing === 'user' ? 'environment' : 'user'); startMode('camera'); }

    // --- 4. è—ç‰™èˆ‡æ•¸æ“šå°å‡º ---
    async function connectBLE() {
        if (!navigator.bluetooth) return alert("iPhone è«‹ä½¿ç”¨ Bluefy ç€è¦½å™¨");
        try {
            const dev = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }] });
            const server = await dev.gatt.connect();
            const char = await (await server.getPrimaryService('heart_rate')).getCharacteristic('heart_rate_measurement');
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (ev) => {
                bleHR = ev.target.value.getUint8(1);
                document.getElementById('ui-hr').innerText = `${bleHR} bpm`;
            });
            log("è—ç‰™å·²é€£ç·š");
        } catch (e) { log("è—ç‰™é€£ç·šå–æ¶ˆ"); }
    }

    function exportData() {
        const csv = history.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `rowing_data_${Date.now()}.csv`;
        a.click();
    }

    init();
</script>
</body>
</html>