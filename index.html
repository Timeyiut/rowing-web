<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rowing Pro v6.0 (Diagnostic)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --bg: #000; --accent: #FFD700; --err: #FF3D00; --ok: #00E676; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* è¨ºæ–·çµ‚ç«¯æ©Ÿ (æœ€é‡è¦çš„ä¿®æ”¹) */
        #console-log {
            height: 150px; background: rgba(20,20,20,0.95); 
            border-bottom: 2px solid #555; padding: 10px;
            overflow-y: scroll; font-size: 11px; line-height: 1.4;
            display: flex; flex-direction: column-reverse; /* è®“æœ€æ–°è¨Šæ¯åœ¨æœ€ä¸Šæ–¹ */
            z-index: 200;
        }
        .log-info { color: #aaa; }
        .log-ok { color: var(--ok); font-weight: bold; }
        .log-warn { color: var(--accent); }
        .log-err { color: var(--err); background: rgba(255, 61, 0, 0.1); font-weight: bold; border-left: 3px solid var(--err); padding-left: 5px; }

        /* ä¸»ç•«é¢ */
        #stage { flex: 1; position: relative; background: #111; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; pointer-events: none; opacity: 0; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }

        /* å½±ç‰‡é€²åº¦æ§åˆ¶ */
        #timeline-container {
            position: absolute; bottom: 85px; left: 10px; right: 10px;
            height: 30px; z-index: 50; display: none; align-items: center; gap: 10px;
        }
        #timeline-bg { flex: 1; height: 10px; background: #333; border-radius: 5px; position: relative; }
        #timeline-fill { width: 0%; height: 100%; background: var(--accent); border-radius: 5px; }
        #force-btn {
            background: var(--err); color: #fff; border: none; padding: 5px 10px; 
            border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap;
        }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        #controls {
            height: 70px; background: #111; display: flex; gap: 5px; 
            padding: 5px; align-items: center; border-top: 1px solid #333;
        }
        button, label {
            flex: 1; height: 50px; border: 1px solid #333; border-radius: 6px;
            background: #222; color: #ccc; font-size: 11px; font-weight: bold;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .primary { border-color: var(--accent); color: var(--accent); background: rgba(255, 215, 0, 0.1); }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 300;
            display: flex; justify-content: center; align-items: center;
        }
        #start-btn { padding: 15px 40px; font-size: 20px; background: var(--accent); color: #000; border-radius: 30px; border:none;}
    </style>
</head>
<body>

    <div id="overlay"><button id="start-btn" onclick="initSystem()">ğŸ› ï¸ å•Ÿå‹•è¨ºæ–·æ¨¡å¼</button></div>

    <div id="console-log">
        <div>[SYSTEM] ç­‰å¾…ä½¿ç”¨è€…å•Ÿå‹•...</div>
    </div>

    <div id="stage">
        <video id="video" playsinline muted webkit-playsinline crossorigin="anonymous"></video>
        <canvas id="canvas"></canvas>
        
        <div id="timeline-container">
            <button id="force-btn" onclick="forceRender()">âš¡ å¼·åˆ¶é‡ç¹ª</button>
            <div id="timeline-bg" onclick="seekVideo(event)"><div id="timeline-fill"></div></div>
        </div>
    </div>

    <div id="controls">
        <label for="file-in" class="primary">ğŸ“‚ 1.åŒ¯å…¥å½±ç‰‡</label>
        <button onclick="startCamera()">ğŸ“· 2.æ¸¬è©¦ç›¸æ©Ÿ</button>
        <button onclick="exportLogs()">ğŸ“‹ è¤‡è£½ Log</button>
    </div>
    
    <input type="file" id="file-in" accept="video/*" style="display:none">

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const logger = document.getElementById('console-log');
    
    let pose = null;
    let isVideoMode = false;
    let isProcessing = false;
    let frameId = null;

    // --- å¼·åŒ–çš„ Log ç³»çµ± ---
    function log(msg, type='info') {
        const div = document.createElement('div');
        const ts = new Date().toLocaleTimeString('en-US', {hour12: false}) + "." + new Date().getMilliseconds();
        div.innerHTML = `[${ts}] ${msg}`;
        div.className = `log-${type}`;
        logger.prepend(div); // æœ€æ–°è¨Šæ¯åœ¨æœ€ä¸Š
        console.log(`[${type}] ${msg}`);
    }

    // --- 1. ç³»çµ±åˆå§‹åŒ– ---
    async function initSystem() {
        document.getElementById('overlay').style.display = 'none';
        log("ä½¿ç”¨è€…è§¸ç™¼å•Ÿå‹•ï¼Œé–‹å§‹è¼‰å…¥æ¨¡å‹...", "warn");
        
        try {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
            pose.onResults(onResults);
            await pose.initialize();
            log("âœ… MediaPipe æ¨¡å‹è¼‰å…¥æˆåŠŸ (Ready)", "ok");
        } catch (e) {
            log("âŒ æ¨¡å‹å´©æ½°: " + e.message, "err");
        }
    }

    // --- 2. å½±ç‰‡äº‹ä»¶ç›£è½ (è¨ºæ–·æ ¸å¿ƒ) ---
    // ç¶å®šæ‰€æœ‰å¯èƒ½çš„å½±ç‰‡éŒ¯èª¤äº‹ä»¶
    video.addEventListener('error', (e) => {
        const err = video.error;
        log(`âŒ å½±ç‰‡éŒ¯èª¤ä»£ç¢¼: ${err.code}, è¨Šæ¯: ${err.message}`, "err");
        log("æç¤º: Code 3 = è§£ç¢¼éŒ¯èª¤ (iPhone ä¸æ”¯æ´æ­¤æ ¼å¼)", "info");
    });
    video.addEventListener('stalled', () => log("âš ï¸ å½±ç‰‡åœæ»¯ (Stalled) - æ•¸æ“šè®€å–ç·©æ…¢", "warn"));
    video.addEventListener('waiting', () => log("â³ ç­‰å¾…æ•¸æ“š (Waiting)...", "info"));
    video.addEventListener('loadedmetadata', () => {
        log(`â„¹ï¸ å…ƒæ•¸æ“šè¼‰å…¥: ${video.videoWidth}x${video.videoHeight}, é•·åº¦: ${video.duration}s`, "ok");
    });
    video.addEventListener('loadeddata', () => {
        log("âœ… é¦–å¹€è³‡æ–™å·²è¼‰å…¥ (loadeddata)ï¼Œæº–å‚™æ’­æ”¾", "ok");
        attemptPlay();
    });
    video.addEventListener('canplay', () => log("â„¹ï¸ ç€è¦½å™¨å›å ±ï¼šå¯ä»¥é–‹å§‹æ’­æ”¾ (canplay)", "info"));

    // --- 3. åŒ¯å…¥é‚è¼¯ ---
    document.getElementById('file-in').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        log(`ğŸ“‚ è®€å–æª”æ¡ˆ: ${file.name}`, "warn");
        log(`â„¹ï¸ é¡å‹: ${file.type}, å¤§å°: ${(file.size/1024/1024).toFixed(2)} MB`, "info");

        // æª¢æŸ¥æ ¼å¼
        if (file.type.indexOf('video') === -1) {
            log("âŒéŒ¯èª¤ï¼šé€™ä¸æ˜¯å½±ç‰‡æª”ï¼", "err");
            return;
        }

        isVideoMode = true;
        stopAll();
        document.getElementById('timeline-container').style.display = 'flex';

        const url = URL.createObjectURL(file);
        log(`ğŸ”— Blob URL å·²å»ºç«‹: ${url}`, "info");
        
        video.src = null;
        video.src = url;
        video.load(); // å¼·åˆ¶è§¸ç™¼è¼‰å…¥
    };

    function attemptPlay() {
        const playPromise = video.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                log("â–¶ï¸ æ’­æ”¾ Promise æˆåŠŸResolved", "ok");
                isProcessing = true;
                processLoop();
            }).catch(error => {
                log(`âŒ æ’­æ”¾è¢«ç€è¦½å™¨é˜»æ“‹: ${error}`, "err");
                log("æç¤º: è«‹å˜—è©¦é»æ“Šã€å¼·åˆ¶é‡ç¹ªã€æŒ‰éˆ•", "warn");
            });
        }
    }

    // --- 4. åˆ†æå¾ªç’° ---
    async function processLoop() {
        if (!isProcessing) return;
        
        if (video.paused || video.ended) {
            // æš«åœæ™‚ä¸åˆ†æï¼Œç¯€çœè³‡æº
            frameId = requestAnimationFrame(processLoop);
            return;
        }

        try {
            await pose.send({image: video});
            
            // æ›´æ–°é€²åº¦æ¢
            if (isVideoMode && video.duration) {
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('timeline-fill').style.width = pct + '%';
            }
        } catch (e) {
            log("âš ï¸ åˆ†æå¾ªç’°å ±éŒ¯ (å¿½ç•¥): " + e.message, "warn");
        }
        
        frameId = requestAnimationFrame(processLoop);
    }

    function onResults(results) {
        // å¦‚æœèƒ½é€²åˆ°é€™è£¡ï¼Œä»£è¡¨ AI æœ‰åœ¨é‹ä½œ
        if (canvas.width !== video.videoWidth) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(ctx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1});
        }
        ctx.restore();
    }

    // --- 5. æ•‘æ´åŠŸèƒ½ ---
    function forceRender() {
        log("âš¡ ä½¿ç”¨è€…è§¸ç™¼å¼·åˆ¶é‡ç¹ª", "warn");
        if (video.paused) {
            log("å½±ç‰‡è™•æ–¼æš«åœç‹€æ…‹ï¼Œå˜—è©¦æ’­æ”¾...", "info");
            video.play();
        }
        isProcessing = true;
        processLoop();
    }

    function startCamera() {
        log("åˆ‡æ›è‡³ç›¸æ©Ÿæ¨¡å¼...", "warn");
        stopAll();
        isVideoMode = false;
        document.getElementById('timeline-container').style.display = 'none';

        navigator.mediaDevices.getUserMedia({video: {facingMode: 'user', width: 640}})
            .then(stream => {
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    isProcessing = true;
                    processLoop();
                    log("ğŸ“· ç›¸æ©Ÿä¸²æµå·²å•Ÿå‹•", "ok");
                };
            })
            .catch(err => log("âŒ ç›¸æ©Ÿæ¬Šé™éŒ¯èª¤: " + err.message, "err"));
    }

    function stopAll() {
        isProcessing = false;
        if (frameId) cancelAnimationFrame(frameId);
        video.pause();
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => t.stop());
            video.srcObject = null;
        }
        video.src = "";
    }
    
    function seekVideo(e) {
        if (!video.duration) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        video.currentTime = pos * video.duration;
        log(`â© è·³è½‰è‡³ ${(pos*100).toFixed(0)}%`, "info");
    }

    function exportLogs() {
        const txt = logger.innerText;
        navigator.clipboard.writeText(txt).then(() => alert("Log å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"));
    }
</script>
</body>
</html>