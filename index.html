<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rowing Analysis Pro - Web Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        :root { --accent: #2196F3; --danger: #ff3d00; --bg: #000; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow: hidden; }
        #app { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        
        canvas { width: 100%; height: auto; object-fit: contain; background: #000; }
        .mirrored { transform: scaleX(-1); }
        video { position: absolute; width: 1px; height: 1px; opacity: 0; }

        /* å„€è¡¨æ¿ (æ¯›ç»ç’ƒæ•ˆæœ) */
        #dashboard {
            position: absolute; top: 15px; left: 15px; right: 15px;
            padding: 15px; background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); z-index: 10;
        }
        .metric { font-family: monospace; margin: 4px 0; font-size: 14px; }
        #hr-display { font-size: 24px; color: var(--danger); font-weight: bold; }

        /* é€²åº¦æ¢ */
        #progress-wrap {
            position: absolute; bottom: 100px; left: 20px; right: 20px;
            height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px;
            display: none; cursor: pointer; z-index: 15;
        }
        #progress-bar { width: 0%; height: 100%; background: #4caf50; border-radius: 5px; }

        /* æ§åˆ¶åˆ— */
        #toolbar {
            position: absolute; bottom: 20px; width: 100%;
            display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; z-index: 20;
        }
        button, label {
            padding: 10px 16px; border-radius: 20px; border: none; cursor: pointer;
            font-weight: bold; font-size: 13px; background: var(--accent); color: #fff;
        }
        .btn-secondary { background: #673ab7; }
        .btn-success { background: #4caf50; }
        .btn-warn { background: #e91e63; }
    </style>
</head>
<body>

<div id="app">
    <video id="input_video" playsinline muted webkit-playsinline></video>
    <canvas id="output_canvas" class="mirrored"></canvas>

    <div id="progress-wrap"><div id="progress-bar"></div></div>

    <div id="dashboard">
        <div id="ts" class="metric">TS: 00:00:00.000</div>
        <div id="hr-display">HR: -- bpm</div>
        <div id="phase" style="color: #0f0; font-weight: bold;">PHASE: IDLE</div>
        <div class="metric">KNEE: <span id="knee-ang">0</span>Â° | HIP: <span id="hip-ang">0</span>Â°</div>
    </div>

    <div id="toolbar">
        <button onclick="initCamera()">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿ</button>
        <button onclick="switchCamera()">ğŸ”„ åˆ‡æ›é¡é ­</button>
        <label for="vid-upload" class="btn-secondary">ğŸ¬ åŒ¯å…¥å½±ç‰‡</label>
        <input type="file" id="vid-upload" accept="video/*" hidden>
        <button id="bt-conn" class="btn-warn" onclick="connectBLE()">ğŸ”— è—ç‰™é€£ç·š</button>
        <button class="btn-success" onclick="exportCSV()">ğŸ’¾ åŒ¯å‡ºæ•¸æ“š</button>
    </div>
</div>

<script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('output_canvas');
    const ctx = canvas.getContext('2d');
    
    let camera = null;
    let isVideo = false;
    let currentHR = 0;
    let facing = 'user';
    let dataLog = [["Timestamp", "HR", "Knee", "Hip", "Phase"]];

    // --- MediaPipe æ ¸å¿ƒ ---
    const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

    function getAngle(p1, p2, p3) {
        const rad = Math.atan2(p3.y - p2.y, p3.x - p2.x) - Math.atan2(p1.y - p2.y, p1.x - p2.x);
        let ang = Math.abs(rad * 180.0 / Math.PI);
        return Math.round(ang > 180 ? 360 - ang : ang);
    }

    pose.onResults((res) => {
        if (!res.poseLandmarks) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
        
        drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
        
        const lm = res.poseLandmarks;
        const knee = getAngle(lm[23], lm[25], lm[27]);
        const hip = getAngle(lm[11], lm[23], lm[25]);
        
        document.getElementById('knee-ang').innerText = knee;
        document.getElementById('hip-ang').innerText = hip;
        
        const now = new Date();
        const ts = now.toISOString().split('T')[1].replace('Z', '');
        document.getElementById('ts').innerText = `TS: ${ts}`;
        
        let ph = "Drive";
        if (knee < 85) ph = "Catch";
        else if (knee > 160) ph = "Finish";
        document.getElementById('phase').innerText = `PHASE: ${ph}`;

        dataLog.push([now.toISOString(), currentHR, knee, hip, ph]);
    });

    // --- ç¡¬é«”èˆ‡é€šè¨Š ---
    async function initCamera() {
        isVideo = false;
        canvas.classList.add('mirrored');
        document.getElementById('progress-wrap').style.display = 'none';
        if(camera) await camera.stop();
        camera = new Camera(video, {
            onFrame: async () => { await pose.send({image: video}); },
            width: 1280, height: 720, facingMode: facing
        });
        camera.start();
    }

    async function switchCamera() {
        facing = (facing === 'user') ? 'environment' : 'user';
        initCamera();
    }

    document.getElementById('vid-upload').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        isVideo = true;
        canvas.classList.remove('mirrored');
        document.getElementById('progress-wrap').style.display = 'block';
        video.src = URL.createObjectURL(file);
        video.play();
        const loop = async () => {
            if (!isVideo || video.paused || video.ended) return;
            await pose.send({image: video});
            const pct = (video.currentTime / video.duration) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';
            requestAnimationFrame(loop);
        };
        video.onplay = loop;
    };

    async function connectBLE() {
        if (!navigator.bluetooth) {
            alert("æ­¤ç’°å¢ƒä¸æ”¯æ´è—ç‰™ (iPhone è«‹ä½¿ç”¨ Bluefy App)");
            return;
        }
        try {
            const dev = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }] });
            const server = await dev.gatt.connect();
            const char = await (await server.getPrimaryService('heart_rate')).getCharacteristic('heart_rate_measurement');
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (ev) => {
                currentHR = ev.target.value.getUint8(1);
                document.getElementById('hr-display').innerText = `HR: ${currentHR} bpm`;
            });
            document.getElementById('bt-conn').innerText = "âœ… å·²é€£ç·š";
        } catch (err) { console.log(err); }
    }

    function exportCSV() {
        const csv = dataLog.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rowing_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
