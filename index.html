<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rowing Pro Web - iPhone 優化版</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        
        /* iPhone 優化：確保 Canvas 填滿畫面 */
        #output_canvas { width: 100%; height: auto; object-fit: contain; }
        
        /* 隱藏原始影片，但必須存在且具備必要屬性 */
        #input_video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        #ui-panel {
            position: absolute; top: 10px; left: 10px; right: 10px;
            padding: 10px; background: rgba(0, 0, 0, 0.6); border-radius: 8px;
            z-index: 10; pointer-events: none;
        }
        .data-line { margin: 2px 0; font-size: 14px; }
        
        /* 【除錯專用】顯示在畫面底部的 Log */
        #debug-log {
            position: absolute; bottom: 80px; left: 10px; right: 10px;
            font-size: 10px; color: #aaa; background: rgba(0,0,0,0.5); max-height: 50px; overflow: hidden;
        }

        #controls {
            position: absolute; bottom: 20px; width: 100%;
            display: flex; justify-content: center; gap: 10px; z-index: 20;
        }
        button { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; background: #2196F3; color: white; }
    </style>
</head>
<body>

<div id="container">
    <video id="input_video" playsinline muted autoplay></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui-panel">
        <div id="val-hr" style="font-size: 20px; color: #ff3d00;">HR: 0 bpm</div>
        <div id="val-phase" style="color: #00ff00;">PHASE: Initializing...</div>
        <div class="data-line">KNEE: <span id="ang-knee">0</span> | HIP: <span id="ang-hip">0</span></div>
    </div>

    <div id="debug-log">系統狀態: 準備中...</div>

    <div id="controls">
        <button id="btn-bluetooth" style="background: #e91e63;">連線藍牙</button>
        <button id="btn-download" style="background: #4caf50;">存檔 CSV</button>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const debugLog = document.getElementById('debug-log');

    function log(msg) {
        debugLog.innerText = msg;
        console.log(msg);
    }

    // 1. MediaPipe Pose 設定
    const pose = new Pose({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    function calculateAngle(a, b, c) {
        let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    pose.onResults((results) => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            const lm = results.poseLandmarks;
            const knee = calculateAngle(lm[23], lm[25], lm[27]);
            const hip = calculateAngle(lm[11], lm[23], lm[25]);
            document.getElementById('ang-knee').innerText = knee;
            document.getElementById('ang-hip').innerText = hip;
            document.getElementById('val-phase').innerText = "PHASE: Tracking";
        }
        canvasCtx.restore();
    });

    // 2. iPhone 鏡頭啟動優化
    async function startCamera() {
        log("正在嘗試存取鏡頭...");
        try {
            // 使用 MediaPipe 的 Camera 工具，並明確指定面對方向
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await pose.send({image: videoElement});
                },
                width: 640,
                height: 480,
                // iPhone 改用後鏡頭測試 (environment)，或前鏡頭 (user)
                facingMode: 'user' 
            });
            await camera.start();
            log("鏡頭啟動成功！");
        } catch (err) {
            log("鏡頭錯誤: " + err.message);
            // 備案：手動調用 getUserMedia
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(stream => {
                    videoElement.srcObject = stream;
                    log("手動調用鏡頭成功");
                });
        }
    }

    // 頁面載入後自動嘗試啟動
    window.onload = startCamera;

    // 3. 藍牙連線與 CSV (維持原有邏輯)
    // ... (此處省略部分重複的藍牙代碼)
</script>
</body>
</html>