<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rowing Pro v7.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        /* --- å°ˆæ¥­é‹å‹•é¢¨æ ¼é…è‰² --- */
        :root { 
            --bg: #000; 
            --accent: #00E5FF; /* ç§‘æŠ€è— */
            --panel: rgba(20, 20, 20, 0.85); 
            --text-main: #fff;
            --text-sub: #aaa;
            --phase-catch: #4CAF50; /* ç¶ è‰² */
            --phase-finish: #FF5252; /* ç´…è‰² */
        }

        body { margin: 0; background: var(--bg); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* ä¸»èˆå° */
        #stage { 
            flex: 1; position: relative; background: #111; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        /* å †ç–Šå±¤ï¼šå½±ç‰‡åœ¨ä¸‹ï¼Œç•«å¸ƒåœ¨ä¸Š */
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; opacity: 0; pointer-events: none; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        .mirrored { transform: scaleX(-1); }

        /* æ‡¸æµ®å„€è¡¨æ¿ (HUD) */
        #hud {
            position: absolute; top: 20px; left: 15px; right: 15px;
            padding: 12px; background: var(--panel); border-radius: 16px;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1); z-index: 10;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-val { font-size: 18px; font-weight: 800; font-family: 'SF Mono', monospace; color: var(--text-main); }
        .stat-label { font-size: 10px; color: var(--text-sub); text-transform: uppercase; margin-top: 2px; }
        
        /* ç›¸ä½æŒ‡ç¤ºå™¨ (Catch/Finish) */
        #phase-pill {
            grid-column: span 4; margin-top: 8px; padding: 4px;
            background: rgba(255,255,255,0.1); border-radius: 8px;
            text-align: center; font-size: 12px; font-weight: bold; letter-spacing: 1px;
            color: var(--accent);
        }

        /* å½±ç‰‡æ™‚é–“è»¸ */
        #timeline-container {
            position: absolute; bottom: 90px; left: 20px; right: 20px;
            height: 40px; z-index: 20; display: none; align-items: center;
        }
        #timeline-track {
            width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; position: relative;
        }
        #timeline-fill {
            width: 0%; height: 100%; background: var(--accent); border-radius: 3px;
        }
        /* æ™‚é–“è»¸æ‹–æ›³çƒ */
        #timeline-thumb {
            width: 14px; height: 14px; background: #fff; border-radius: 50%;
            position: absolute; top: 50%; transform: translate(-50%, -50%); left: 0%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        #controls {
            height: 80px; background: #0a0a0a; border-top: 1px solid #222;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 30;
        }
        .btn {
            background: none; border: none; color: #888; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 10px; width: 60px;
        }
        .btn-icon {
            width: 44px; height: 44px; background: #222; border-radius: 22px;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            transition: 0.2s;
        }
        .btn.active .btn-icon { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .btn:active .btn-icon { transform: scale(0.9); }

        /* å•Ÿå‹•é®ç½© (iOS å¿…éœ€) */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            padding: 18px 40px; border-radius: 40px; border: none;
            background: var(--accent); color: #000; font-size: 18px; font-weight: bold;
            box-shadow: 0 0 20px rgba(0,229,255,0.4);
        }
        
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <button id="start-btn" onclick="initSystem()">ğŸš€ å•Ÿå‹•åˆ†æç³»çµ±</button>
        <div style="margin-top: 10px; color: #888; font-size: 12px;">v7.0 Stable Release</div>
    </div>

    <div id="stage">
        <video id="video" playsinline muted webkit-playsinline loop crossorigin="anonymous"></video>
        <canvas id="canvas"></canvas>

        <div id="hud">
            <div class="stat-item">
                <div class="stat-val" id="val-time">00:00</div>
                <div class="stat-label">TIME</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="val-hr" style="color: #FF5252;">--</div>
                <div class="stat-label">BPM</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="val-knee">0Â°</div>
                <div class="stat-label">KNEE</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="val-hip">0Â°</div>
                <div class="stat-label">HIP</div>
            </div>
            <div id="phase-pill">SYSTEM READY</div>
        </div>

        <div id="timeline-container">
            <div id="timeline-track" onclick="seekVideo(event)">
                <div id="timeline-fill"></div>
                <div id="timeline-thumb"></div>
            </div>
        </div>
    </div>

    <div id="controls">
        <label for="file-input" class="btn active">
            <div class="btn-icon">ğŸ“‚</div>
            <span>åŒ¯å…¥å½±ç‰‡</span>
        </label>
        <button class="btn" onclick="startCamera()">
            <div class="btn-icon">ğŸ“·</div>
            <span>ç›¸æ©Ÿ</span>
        </button>
        <button class="btn" onclick="toggleFacing()">
            <div class="btn-icon">ğŸ”„</div>
            <span>ç¿»è½‰</span>
        </button>
        <button class="btn" onclick="connectBLE()">
            <div class="btn-icon">â¤ï¸</div>
            <span>è—ç‰™</span>
        </button>
        <button class="btn" onclick="exportData()">
            <div class="btn-icon">ğŸ’¾</div>
            <span>å­˜æª”</span>
        </button>
    </div>

    <input type="file" id="file-input" accept="video/*">

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let pose = null;
    let isVideoMode = false;
    let isProcessing = false;
    let facingMode = 'user';
    let currentHR = 0;
    let dataLog = [["Timestamp", "HR", "Knee", "Hip", "Phase"]];
    let animationId;

    // --- 1. ç³»çµ±åˆå§‹åŒ– ---
    async function initSystem() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('phase-pill').innerText = "LOADING MODEL...";
        
        try {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });
            // ä½¿ç”¨æœ€å¹³è¡¡çš„è¨­å®š
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            pose.onResults(onResults);
            await pose.initialize();
            
            document.getElementById('phase-pill').innerText = "WAITING FOR INPUT";
        } catch (e) {
            alert("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†");
        }
    }

    // --- 2. æ ¸å¿ƒåˆ†æé‚è¼¯ ---
    function onResults(results) {
        // ç¢ºä¿ç•«å¸ƒå°ºå¯¸æ­£ç¢º
        if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            // ç¹ªè£½éª¨æ¶
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00E5FF', lineWidth: 3});
            drawLandmarks(ctx, results.poseLandmarks, {color: '#FFF', lineWidth: 1});

            // è¨ˆç®—è§’åº¦
            const lm = results.poseLandmarks;
            const knee = getAngle(lm[23], lm[25], lm[27]);
            const hip = getAngle(lm[11], lm[23], lm[25]);

            // æ›´æ–° UI æ•¸æ“š
            document.getElementById('val-knee').innerText = knee + "Â°";
            document.getElementById('val-hip').innerText = hip + "Â°";

            // ç›¸ä½åˆ¤æ–·
            let phase = "DRIVE";
            const pill = document.getElementById('phase-pill');
            
            if (knee < 85) {
                phase = "CATCH";
                pill.style.color = "var(--phase-catch)";
            } else if (knee > 155) {
                phase = "FINISH";
                pill.style.color = "var(--phase-finish)";
            } else {
                pill.style.color = "var(--accent)";
            }
            pill.innerText = phase;

            // æ›´æ–°æ™‚é–“èˆ‡é€²åº¦æ¢ (è‹¥æ˜¯å½±ç‰‡æ¨¡å¼)
            const now = new Date();
            let ts;
            
            if (isVideoMode) {
                ts = video.currentTime.toFixed(2);
                updateTimeline();
            } else {
                ts = now.toLocaleTimeString();
            }
            document.getElementById('val-time').innerText = isVideoMode ? formatTime(video.currentTime) : ts.split(' ')[0];

            // å­˜å…¥ Log
            dataLog.push([ts, currentHR, knee, hip, phase]);
        }
        ctx.restore();
    }

    function getAngle(a, b, c) {
        let ang = Math.abs((Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x)) * 180/Math.PI);
        return Math.round(ang > 180 ? 360-ang : ang);
    }

    // --- 3. åŒ¯å…¥å½±ç‰‡ (v6.0 ä¿®å¾©ç‰ˆé‚è¼¯) ---
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        stopAll();
        isVideoMode = true;
        document.getElementById('timeline-container').style.display = 'flex';
        canvas.classList.remove('mirrored');

        const url = URL.createObjectURL(file);
        video.src = url;
        
        // é—œéµï¼šç¢ºä¿ iOS è¼‰å…¥å®Œæˆæ‰æ’­æ”¾
        video.onloadeddata = () => {
            video.play().then(() => {
                isProcessing = true;
                processLoop();
            }).catch(err => {
                alert("æ’­æ”¾è¢«æ””æˆªï¼Œè«‹é»æ“Šç•«é¢ä»»æ„è™•");
            });
        };
    };

    // --- 4. ç›¸æ©ŸåŠŸèƒ½ ---
    async function startCamera() {
        stopAll();
        isVideoMode = false;
        document.getElementById('timeline-container').style.display = 'none';
        
        if (facingMode === 'user') canvas.classList.add('mirrored');
        else canvas.classList.remove('mirrored');

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode, width: 1280, height: 720 }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                isProcessing = true;
                processLoop();
            };
        } catch (e) {
            alert("ç›¸æ©Ÿæ¬Šé™éŒ¯èª¤: " + e.message);
        }
    }

    function toggleFacing() {
        facingMode = (facingMode === 'user') ? 'environment' : 'user';
        if (!isVideoMode) startCamera();
    }

    // --- 5. å¾ªç’°å¼•æ“ ---
    function processLoop() {
        if (!isProcessing) return;
        
        if (!video.paused && !video.ended) {
            pose.send({image: video});
        }
        animationId = requestAnimationFrame(processLoop);
    }

    function stopAll() {
        isProcessing = false;
        if (animationId) cancelAnimationFrame(animationId);
        video.pause();
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => t.stop());
            video.srcObject = null;
        }
        video.src = "";
    }

    // --- 6. ä»‹é¢äº’å‹• ---
    function updateTimeline() {
        if (!video.duration) return;
        const pct = (video.currentTime / video.duration) * 100;
        document.getElementById('timeline-fill').style.width = pct + "%";
        document.getElementById('timeline-thumb').style.left = pct + "%";
    }

    function seekVideo(e) {
        if (!isVideoMode || !video.duration) return;
        const rect = document.getElementById('timeline-track').getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        video.currentTime = pct * video.duration;
    }

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

    async function connectBLE() {
        if (!navigator.bluetooth) return alert("iPhone è«‹ä½¿ç”¨ Bluefy App");
        try {
            const dev = await navigator.bluetooth.requestDevice({ filters: [{ services: ['heart_rate'] }] });
            const server = await dev.gatt.connect();
            const char = await (await server.getPrimaryService('heart_rate')).getCharacteristic('heart_rate_measurement');
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                currentHR = e.target.value.getUint8(1);
                document.getElementById('val-hr').innerText = currentHR;
            });
        } catch (e) { console.log(e); }
    }

    function exportData() {
        const csv = dataLog.map(r => r.join(",")).join("\n");
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
        a.download = `rowing_data_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>