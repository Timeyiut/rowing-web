<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rowing Pro iOS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        /* --- 1. ç¾ä»£åŒ– GUI é¢¨æ ¼ --- */
        :root { --bg: #0d1117; --panel: rgba(22, 27, 34, 0.85); --accent: #2f81f7; --text: #e6edf3; --green: #3fb950; --red: #ff7b72; }
        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* ç•«å¸ƒå®¹å™¨ */
        #viewer { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #000; }
        
        /* å½±ç‰‡èˆ‡ Canvas å †ç–Š */
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; opacity: 0; z-index: 1; pointer-events: none; }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; z-index: 2; }
        .mirrored { transform: scaleX(-1); }

        /* å„€è¡¨æ¿ HUD */
        #hud {
            position: absolute; top: safe-area-inset-top; left: 10px; right: 10px;
            padding: 12px; background: var(--panel); border-radius: 12px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); z-index: 10;
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-val { font-size: 18px; font-weight: 700; font-family: 'SF Mono', monospace; color: var(--text); }
        .stat-val.highlight { color: var(--green); }
        .stat-val.alert { color: var(--red); }
        
        #phase-badge { 
            grid-column: span 2; text-align: center; background: rgba(63, 185, 80, 0.2); 
            color: var(--green); padding: 4px; border-radius: 4px; font-weight: bold; margin-top: 4px;
        }

        /* å½±ç‰‡é€²åº¦æ¢ */
        #timeline {
            position: absolute; bottom: 80px; left: 15px; right: 15px; height: 40px; 
            z-index: 20; display: none; align-items: center;
        }
        #seek-bar {
            width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; position: relative;
        }
        #progress { width: 0%; height: 100%; background: var(--accent); border-radius: 3px; position: absolute; left: 0; }
        #thumb { width: 16px; height: 16px; background: #fff; border-radius: 50%; position: absolute; top: -5px; margin-left: -8px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        #controls {
            height: 80px; background: var(--panel); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 30;
        }
        .btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: none; border: none; color: #8b949e; font-size: 10px; cursor: pointer; width: 60px;
        }
        .btn-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 20px; transition: 0.2s; }
        .btn.active .btn-icon { background: var(--accent); color: #fff; box-shadow: 0 0 10px var(--accent); }
        .btn:active .btn-icon { transform: scale(0.95); }

        /* è¼‰å…¥é®ç½© */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: var(--accent);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æª”æ¡ˆè¼¸å…¥éš±è— */
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status-text">è¼‰å…¥ AI æ¨¡å‹ä¸­...</div>
    </div>

    <div id="viewer">
        <video id="video" playsinline muted webkit-playsinline></video>
        <canvas id="canvas" class="mirrored"></canvas>
        
        <div id="hud">
            <div class="stat-box">
                <span class="stat-label">Time</span>
                <span id="val-time" class="stat-val">00:00</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Heart Rate</span>
                <span id="val-hr" class="stat-val alert">--</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Knee Angle</span>
                <span id="val-knee" class="stat-val">0Â°</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Hip Angle</span>
                <span id="val-hip" class="stat-val">0Â°</span>
            </div>
            <div id="phase-badge">READY</div>
        </div>

        <div id="timeline">
            <div id="seek-bar">
                <div id="progress"></div>
                <div id="thumb" style="left: 0%"></div>
            </div>
        </div>
    </div>

    <div id="controls">
        <button class="btn active" id="btn-cam" onclick="startCamera()">
            <div class="btn-icon">ğŸ“·</div>
            <span>ç›¸æ©Ÿ</span>
        </button>
        <button class="btn" onclick="toggleFacing()">
            <div class="btn-icon">ğŸ”„</div>
            <span>ç¿»è½‰</span>
        </button>
        <label for="file-input" class="btn">
            <div class="btn-icon">ğŸ“‚</div>
            <span>åŒ¯å…¥</span>
        </label>
        <button class="btn" id="btn-ble" onclick="connectBluetooth()">
            <div class="btn-icon">â¤ï¸</div>
            <span>è—ç‰™</span>
        </button>
        <button class="btn" onclick="downloadCSV()">
            <div class="btn-icon">ğŸ’¾</div>
            <span>å­˜æª”</span>
        </button>
    </div>

    <input type="file" id="file-input" accept="video/*">

<script>
    // --- è®Šæ•¸å®£å‘Š ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loader');
    const statusText = document.getElementById('status-text');
    const seekBar = document.getElementById('seek-bar');
    
    let pose;
    let camera;
    let isVideoMode = false;
    let isAnalyzing = false;
    let facingMode = 'user';
    let currentHR = 0;
    let dataLog = [["Timestamp", "HR", "Knee", "Hip", "Phase"]];
    let animationId;

    // --- 1. ç³»çµ±åˆå§‹åŒ– (System Init) ---
    async function init() {
        try {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });
            // é™ä½è¤‡é›œåº¦ä»¥æå‡ iOS ç¶²é æ•ˆèƒ½
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            pose.onResults(onResults);
            
            // é ç†±å®Œæˆ
            await pose.initialize();
            loader.style.display = 'none';
            startCamera(); // é è¨­å•Ÿå‹•ç›¸æ©Ÿ
        } catch (e) {
            statusText.innerText = "åˆå§‹åŒ–å¤±æ•—: " + e.message;
        }
    }

    // --- 2. æ ¸å¿ƒåˆ†æè¿´åœˆ (Analysis Loop) ---
    function onResults(results) {
        // è¨­å®š Canvas å°ºå¯¸åŒ¹é…å½±ç‰‡
        if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç¹ªè£½å½±åƒ
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.poseLandmarks) {
            // ç¹ªè£½éª¨æ¶
            drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 3 });
            drawLandmarks(ctx, results.poseLandmarks, { color: '#FF0000', lineWidth: 1 });

            // è¨ˆç®—è§’åº¦
            const lm = results.poseLandmarks;
            const knee = calculateAngle(lm[23], lm[25], lm[27]);
            const hip = calculateAngle(lm[11], lm[23], lm[25]);

            // æ›´æ–° UI
            updateUI(knee, hip);
            
            // è¨˜éŒ„æ•¸æ“š
            if (isAnalyzing) {
                const ts = isVideoMode ? video.currentTime.toFixed(2) : new Date().toLocaleTimeString();
                const phase = document.getElementById('phase-badge').innerText;
                dataLog.push([ts, currentHR, knee, hip, phase]);
            }
        }
        ctx.restore();
    }

    function calculateAngle(a, b, c) {
        let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return Math.round(angle);
    }

    function updateUI(knee, hip) {
        document.getElementById('val-knee').innerText = knee + "Â°";
        document.getElementById('val-hip').innerText = hip + "Â°";
        
        // åˆ¤æ–·ç›¸ä½
        let phase = "DRIVE";
        if (knee < 85) phase = "CATCH";
        else if (knee > 155) phase = "FINISH";
        else if (knee > 100 && hip > 100) phase = "RECOVERY"; // ç°¡å–®åˆ¤æ–·
        
        const badge = document.getElementById('phase-badge');
        badge.innerText = phase;
        
        // æ›´æ–°æ™‚é–“
        if (isVideoMode) {
            const min = Math.floor(video.currentTime / 60).toString().padStart(2, '0');
            const sec = Math.floor(video.currentTime % 60).toString().padStart(2, '0');
            document.getElementById('val-time').innerText = `${min}:${sec}`;
            
            // æ›´æ–°é€²åº¦æ¢
            const pct = (video.currentTime / video.duration) * 100;
            document.getElementById('progress').style.width = pct + "%";
            document.getElementById('thumb').style.left = pct + "%";
        } else {
            document.getElementById('val-time').innerText = new Date().toLocaleTimeString([], {hour12: false});
        }
    }

    // --- 3. æ¨¡å¼æ§åˆ¶ (Camera vs Video) ---
    
    // å•Ÿå‹•ç›¸æ©Ÿ
    async function startCamera() {
        stopAll();
        isVideoMode = false;
        isAnalyzing = true;
        
        canvas.classList.add('mirrored'); // è‡ªæ‹æ¨¡å¼é¡åƒ
        document.getElementById('timeline').style.display = 'none';
        setActiveBtn('btn-cam');

        try {
            camera = new Camera(video, {
                onFrame: async () => {
                    await pose.send({image: video});
                },
                width: 1280, height: 720, facingMode: facingMode
            });
            await camera.start();
        } catch (e) {
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e.message);
        }
    }

    // åˆ‡æ›å‰å¾Œé¡é ­
    function toggleFacing() {
        facingMode = (facingMode === 'user') ? 'environment' : 'user';
        if (!isVideoMode) startCamera();
    }

    // è™•ç†å½±ç‰‡åŒ¯å…¥
    document.getElementById('file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        stopAll();
        isVideoMode = true;
        isAnalyzing = true;
        
        canvas.classList.remove('mirrored'); // å½±ç‰‡ä¸é¡åƒ
        document.getElementById('timeline').style.display = 'flex';
        setActiveBtn(null); // æ¸…é™¤æŒ‰éˆ•ç‹€æ…‹

        const url = URL.createObjectURL(file);
        video.src = url;
        
        // ç¢ºä¿ iOS è¼‰å…¥å®Œæˆ
        video.onloadeddata = () => {
            video.play();
            requestVideoFrame();
        };
    };

    // å½±ç‰‡åˆ†æå¾ªç’°
    function requestVideoFrame() {
        if (!isVideoMode || video.paused || video.ended) return;
        
        pose.send({image: video}).then(() => {
            animationId = requestAnimationFrame(requestVideoFrame);
        });
    }

    function stopAll() {
        if (camera) camera.stop();
        if (animationId) cancelAnimationFrame(animationId);
        video.pause();
        video.src = "";
        isVideoMode = false;
        isAnalyzing = false;
    }

    // --- 4. åŠŸèƒ½æ¨¡çµ„ (Bluetooth & Utils) ---

    // è—ç‰™é€£ç·š (åµæ¸¬ Bluefy)
    async function connectBluetooth() {
        if (!navigator.bluetooth) {
            alert("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è—ç‰™ã€‚\n\niOS ç”¨æˆ¶è«‹ä¸‹è¼‰ 'Bluefy' ç€è¦½å™¨ï¼Œä¸¦åœ¨æ­¤ App ä¸­é–‹å•Ÿæœ¬ç¶²é ã€‚");
            return;
        }

        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['heart_rate'] }]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService('heart_rate');
            const char = await service.getCharacteristic('heart_rate_measurement');
            
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                currentHR = e.target.value.getUint8(1);
                const hrEl = document.getElementById('val-hr');
                hrEl.innerText = currentHR + " bpm";
                hrEl.classList.remove('alert');
                hrEl.classList.add('highlight');
            });
            
            document.getElementById('btn-ble').classList.add('active');
            alert("å·²é€£ç·š: " + device.name);
        } catch (e) {
            alert("é€£ç·šå¤±æ•—: " + e.message);
        }
    }

    // é€²åº¦æ¢æ‹–æ‹‰
    seekBar.onclick = (e) => {
        if (!isVideoMode || !video.duration) return;
        const rect = seekBar.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        video.currentTime = pct * video.duration;
        if (video.paused) {
            video.play();
            requestVideoFrame();
        }
    };

    // ä¸‹è¼‰ CSV
    window.downloadCSV = () => {
        const csvContent = "data:text/csv;charset=utf-8," + dataLog.map(e => e.join(",")).join("\n");
        const link = document.createElement("a");
        link.href = encodeURI(csvContent);
        link.download = `rowing_data_${Date.now()}.csv`;
        link.click();
    };

    function setActiveBtn(id) {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        if (id) document.getElementById(id).classList.add('active');
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>